# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

### Client (React + Vite + TypeScript)
Located in `client/` directory:
- `npm run dev` - Start development server
- `npm run build` - Build for production (runs TypeScript compilation then Vite build)
- `npm run lint` - Run ESLint
- `npm run preview` - Preview production build

### Server (Node.js + Express)
Located in `server/` directory:
- `node server.js` - Start production server
- `nodemon server.js` - Start development server with auto-restart (requires nodemon to be installed)
- Server runs on port 3001 by default

## Rules
- Before you do any work, MUST view files in .claude/tasks/discussion_<issue>.md file to get the full context (<issue> being the issue we are working on. If the file doesn’t exist, then create one)
- .claude/tasks/discussion_<issue>.md should contain most of context of what we did, overall plan, and sub agents will continusly add context to the file
- After you finish the work, MUST update the .claude/tasks/discussion_<issue>.md file to make sure others can get full context of what you did

### Sub-agents
You have access to multiple sub-agents:
Sub-agents will do research about the implementation, but you will do the actual implementation;
When passing task to sub-agent, make sure you pass the context file, e.g. ‘.claude/tasks/discussion_<issue>.md’,
After each sub-agent finish the work, make sure you read the related documentation generated by the sub-agent to get the update before you start executing

### Deployment Options

#### Local Development
1. Start server: `cd server && node server.js`
2. Start client: `cd client && npm run dev`
3. Access at `http://localhost:5173` (client dev server proxies API calls to localhost:3001)

#### Cloudflared Tunnel (External Access)
1. Start server: `cd server && node server.js`
2. Run tunnel: `cloudflared tunnel --url http://localhost:3001`
3. Access via the cloudflared URL provided (serves both frontend build and API)
4. Note: For cloudflared, build the client first: `cd client && npm run build`

## Architecture Overview

### Application Structure
This is a full-stack reflection and journaling application called "Replay" with:
- **Frontend**: React 19 + TypeScript + Vite client application with bottom tab navigation
- **Backend**: Node.js Express server with Supabase PostgreSQL database
- **Authentication**: Supabase Auth with JWT authentication and multi-user support
- **File Storage**: Supabase Storage for audio files, images, and profile pictures
- **AI Integration**: Uses Google Gemini for transcription/content generation and Replicate for text-to-speech

### Core Features
1. **Multi-User Authentication**: Secure user registration and login via Supabase Auth with email/password authentication
2. **User Onboarding**: 3-step onboarding flow for new users (name, values, mission)
3. **Multi-Modal Journaling**: Record voice notes, upload photos with captions, or write text entries - all automatically titled and categorized
4. **Note Categorization**: Automatic categorization of notes into ideas or experiences
5. **Advanced Search**: Full-text search across all experiences with filtering capabilities
6. **Reflection Generation**: Creates personalized guided meditations from selected experiences using AI with multiple meditation types (guided, affirmation, breathwork)
7. **Background Job Processing**: Asynchronous meditation generation with status tracking and retry capabilities
8. **Profile Management**: User-specific profiles with values, mission, and profile picture upload
9. **Experience Management**: Timeline view with edit/delete capabilities, category badges, and date grouping
10. **Statistics & Tracking**: Meditation streak tracking, monthly stats, and calendar view of meditation history
11. **Replay Radio**: AI-powered daily meditation generation based on user's recent experiences
12. **User Data Isolation**: Complete data separation between users with Row Level Security

### Key Components

#### Client Architecture (`client/src/`)
- **App.tsx**: Main router with Supabase AuthProvider wrapper and protected routes
- **contexts/AuthContext.tsx**: Supabase authentication context and hooks
- **lib/supabase.ts**: Supabase client configuration
- **pages/LoginPage.tsx**: Custom-branded login page with Supabase Auth integration
- **pages/SignUpPage.tsx**: Registration page with feature preview and Supabase Auth integration  
- **pages/OnboardingPage.tsx**: 3-step onboarding flow for new users (name, values, mission)
- **pages/ExperiencesPage.tsx**: Main dashboard showing experiences timeline with both audio and photo notes
- **pages/ReflectionsPage.tsx**: Reflection generation workflow and saved meditations player
- **pages/ProfilePage.tsx**: User profile editing with profile picture upload functionality
- **components/AudioRecorder.tsx**: Handles microphone recording with MediaRecorder API
- **components/MeditationPlayer.tsx**: Plays generated meditation playlists (speech + pause segments)
- **components/NoteCard.tsx**: Displays individual notes with transcripts (supports audio, photo, and text)
- **components/BottomTabNavigation.tsx**: Bottom navigation between main app sections
- **components/FloatingUploadButton.tsx**: Floating action button with multi-modal upload options
- **components/PhotoUploadModal.tsx**: Modal for uploading photos with captions
- **components/TextUploadModal.tsx**: Modal for writing text entries with optional image
- **components/EditExperienceModal.tsx**: Modal for editing existing experiences
- **components/UploadOptionsModal.tsx**: Modal for selecting upload type (voice, photo, text)
- **components/SearchBar.tsx**: Search input component with debouncing
- **components/SearchResults.tsx**: Display search results with filtering
- **components/SearchResultModal.tsx**: Full-screen modal for search functionality
- **components/SearchResultCard.tsx**: Individual search result card component
- **components/TimePeriodModal.tsx**: Time period selector for reflection generation
- **components/DurationSelectorModal.tsx**: Duration selector for meditation length
- **components/ExperienceSelectionModal.tsx**: Experience selection interface for reflections
- **components/ReplayModeSelectionModal.tsx**: Selection for Replay Radio meditation types
- **components/ReflectionTypeModal.tsx**: Selection for standard meditation types
- **components/MeditationSubTypeModal.tsx**: Sub-type selection for meditation variants
- **components/MeditationGeneratingModal.tsx**: Progress indicator with background job status
- **components/BackgroundJobIndicator.tsx**: Shows active background meditation generation jobs
- **components/ReadyToBeginModal.tsx**: Pre-meditation preparation screen
- **components/CalendarModal.tsx**: Calendar view for meditation history
- **components/RecentActivityCalendar.tsx**: Compact calendar for recent activity
- **components/StatsCards.tsx**: Display meditation statistics
- **components/Header.tsx**: App header with user info and stats
- **components/SupabaseImage.tsx**: Optimized image component for Supabase Storage
- **types.ts**: TypeScript interfaces (Note supports audio, photo, and text types; MeditationJob for background processing)
- **utils/api.ts**: Authenticated API utility with automatic JWT token handling
- **utils/dateUtils.ts**: Date formatting and grouping utilities
- **utils/categoryUtils.ts**: Note categorization logic and category definitions (ideas or experiences only)

#### Server Architecture (`server/`)
- **server.js**: Express server with Supabase JWT authentication and database integration
- **middleware/auth.js**: Custom Supabase JWT verification middleware
- **Database**: Supabase PostgreSQL with user-specific tables (profiles, notes, meditations)
- **Media Storage**: Supabase Storage with user-specific buckets for audio files, images, and profile pictures
- **Authentication**: All API routes protected with custom Supabase `requireAuth()` middleware
- **API Routes** (all require authentication):
  - `GET /api/auth/test` - Test authentication middleware (returns user info)
  - `GET /api/debug/ffmpeg` - Debug endpoint for ffmpeg path resolution
  - `GET /api/notes` - Get user's notes with pagination and filtering
  - `GET /api/notes/date-range` - Get user's notes within date range for reflection
  - `GET /api/notes/search` - Search notes with full-text search
  - `GET /api/notes/:id` - Get specific note by ID
  - `POST /api/notes` - Create user's audio note (with file upload)
  - `POST /api/notes/photo` - Create user's photo note (with image upload)
  - `POST /api/notes/text` - Create user's text note (with optional image)
  - `PUT /api/notes/:id` - Update existing note (edit functionality)
  - `DELETE /api/notes/:id` - Delete user's note
  - `GET/POST /api/profile` - User profile management
  - `POST /api/profile/image` - Upload profile image (with file upload)
  - `POST /api/reflect/suggest` - Get suggested experiences for user's reflection
  - `POST /api/reflect/summary` - Generate reflection summary for user
  - `POST /api/meditate` - Generate meditation synchronously (deprecated)
  - `POST /api/meditate/jobs` - Create background meditation generation job
  - `GET /api/meditate/jobs` - Get all user's meditation jobs
  - `GET /api/meditate/jobs/:id` - Get specific job status
  - `POST /api/meditate/jobs/:id/retry` - Retry failed job
  - `DELETE /api/meditate/jobs/:id` - Delete job
  - `POST /api/replay/radio` - Generate Replay Radio meditation
  - `GET /api/meditations` - Get user's saved meditations
  - `GET /api/meditations/:id` - Get specific meditation by ID
  - `PUT /api/meditations/:id/mark-viewed` - Mark meditation as viewed
  - `POST /api/meditations/:id/complete` - Mark meditation as completed
  - `DELETE /api/meditations/:id` - Delete user's meditation
  - `GET /api/meditations/day/default` - Get default day meditation playlist
  - `GET /api/stats/streak` - Get user's meditation streak count
  - `GET /api/stats/monthly` - Get current month's meditation count
  - `GET /api/stats/calendar` - Get all meditation dates for calendar display
  - `GET /api/files/profiles/:userId/:filename` - Serve profile images with signed URLs
  - `GET /api/files/images/:userId/:filename` - Serve note images with signed URLs
  - `GET /api/files/audio/:userId/:filename` - Serve audio files with signed URLs

### AI Workflow
1. **Audio Note Creation**: Audio upload → Gemini transcription → Gemini title generation → Category assignment
2. **Photo Note Creation**: Image upload + caption → Gemini enhanced description → Gemini title generation → Category assignment
3. **Text Note Creation**: Text input + optional image → Gemini title generation → Category assignment
4. **Reflection Generation**: Selected experiences + profile + date range → Gemini reflection summary → Gemini meditation script → Replicate TTS → Audio playlist with speech/pause segments
5. **Background Processing**: Meditation generation runs as background job with status tracking, retry capability, and progress updates
6. **Replay Radio**: Automatic daily meditation generation based on recent experiences with multiple meditation type options

### Environment Variables Required

#### Server Environment (`server/.env`)
- `GEMINI_API_KEY` - Google Generative AI API key for transcription and content generation
- `REPLICATE_API_TOKEN` - Replicate API token for TTS (text-to-speech generation)
- `SUPABASE_URL` - Supabase project URL
- `SUPABASE_ANON_KEY` - Supabase anonymous key (public)
- `SUPABASE_SERVICE_ROLE_KEY` - Supabase service role key (private, for server operations)
- `PORT` - Server port (defaults to 3001)

Note: OpenAI API key is NOT required - the app uses Replicate for TTS instead

#### Client Environment (`client/.env`)
- `VITE_SUPABASE_URL` - Supabase project URL for client-side operations
- `VITE_SUPABASE_ANON_KEY` - Supabase anonymous key for client-side authentication
- `VITE_API_URL` - API base URL (http://localhost:3001 for local development)

### Data Flow
All data is user-specific and isolated by `user_id` (Supabase Auth UUID). Notes support audio, photo, and text types with fields: id, user_id, title, transcript (transcription for audio, enhanced caption for photos, or text content), date, type ('audio'|'photo'|'text'), category ('idea'|'experience'), audioUrl (Supabase Storage URLs), imageUrl (Supabase Storage URLs), originalCaption (photo/text only), duration (audio only). User profiles contain id, user_id, name, values, mission, and profile_image_url. Meditations are linked to users and reference their noteIds with playlists containing speech segments (Supabase Storage audio URLs) and pause segments (durations). Background jobs track meditation generation with status, progress, and error handling.

### Technology Stack
- **Frontend**: React 19, TypeScript, Vite, React Router DOM, Lucide React icons, Axios
- **Authentication**: Supabase Auth (JWT tokens, email/password authentication, user management)
- **Backend**: Express 4, Multer (file uploads), UUID, CORS, dotenv, WAV processing, Helmet (security), rate limiting
- **Database**: Supabase PostgreSQL with Row Level Security (RLS)
- **Storage**: Supabase Storage (audio files, images, profile pictures) with signed URLs
- **AI**: Google Generative AI (Gemini models), Replicate (TTS)
### Database Schema
The application uses Supabase PostgreSQL with the following tables:
- **profiles**: User profiles (id, user_id, name, values, mission, profile_image_url, timestamps)
- **notes**: User notes (id, user_id, title, transcript, category, type, date, duration, audio_url, image_url, original_caption, timestamps)
- **meditations**: User meditations (id, user_id, title, playlist, note_ids, script, duration, summary, time_of_reflection, type, sub_type, timestamps)
- **meditation_completions**: Track meditation completion history (id, user_id, meditation_id, completed_at)
- **meditation_jobs**: Background job tracking (id, user_id, status, progress, meditation_id, error, metadata, timestamps)

All tables have Row Level Security (RLS) enabled for user data isolation using `auth.uid()`.

## REMINDER
Remember to create the .claude/tasks/discussion_<issue>.md file. 